<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Figma Codegen</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        padding: 16px;
        margin: 0;
        background-color: #f5f5f5;
        color: #1c1b1c;
      }
      h2 {
        margin-top: 0;
        font-size: 16px;
      }
      p {
        color: #555;
        font-size: 13px;
        line-height: 1.5;
        margin: 4px 0 8px;
      }
      button {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
        transition: background-color 0.2s;
      }
      button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }
      #generate {
        background-color: #0d99ff;
        color: white;
      }
      #generate:disabled {
        background-color: #a0a0a0;
      }
      #stop {
        background-color: #f24822;
        color: white;
        display: none; /* –°—Ö–æ–≤–∞–Ω–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
      }
      #stop:disabled {
        background-color: #a0a0a0;
      }
      #update-tokens {
        background-color: #555;
        color: white;
      }
      hr {
        border: none;
        border-top: 1px solid #e0e0e0;
        margin: 20px 0;
      }
      .status {
        text-align: center;
        font-size: 12px;
        height: 16px;
        color: #888;
        margin-top: 4px;
        transition: color 0.2s;
      }
    </style>
  </head>
  <body>
    <h2>Wisp v0.1 üöÄ</h2>

    <p>Build or Update Tokens File</p>
    <button id="update-tokens">Build & Update Tokens</button>
    <div id="status-tokens" class="status"></div>

    <hr />

    <p>Select Component Set and Generate Component</p>
    <p>* Component props are generated only once</p>
    <p>* Use Generate to update CSS for components</p>
    <button id="generate">Generate Components</button>
    <button id="stop">Stop</button>
    <div id="status-generate" class="status"></div>

    <script>

      // --- Define UI Elements in DOM ---
      const generateButton = document.getElementById("generate");
      const stopButton = document.getElementById("stop");
      const updateTokensButton = document.getElementById("update-tokens");
      const statusGenerateDiv = document.getElementById("status-generate");
      const statusTokensDiv = document.getElementById("status-tokens");

      // --- Stop Generation Function ---
      function resetGenerateUI(message = "") {
        generateButton.disabled = false;
        stopButton.style.display = "none";
        stopButton.disabled = false;
        statusGenerateDiv.textContent = message;
      }

      // --- onClick functions ---
      updateTokensButton.onclick = () => {
        statusTokensDiv.textContent = "üîÑ Building Tokens...";
        updateTokensButton.disabled = true;
        parent.postMessage({ pluginMessage: { type: "tokens-update" } }, "*");
      };

      generateButton.onclick = () => {
        statusGenerateDiv.textContent = "üîÑ Building Component...";
        generateButton.disabled = true;
        stopButton.style.display = "block";
        parent.postMessage(
          { pluginMessage: { type: "components-generate" } },
          "*"
        );
      };

      stopButton.onclick = () => {
        fetch("https://localhost:9000/components/cancel", { method: "POST" }).catch(
          (err) => console.error("Failed to send cancel request:", err)
        );
        parent.postMessage({ pluginMessage: { type: "notify-cancel" } }, "*");
        resetGenerateUI();
      };

      // --- –Ñ–¥–∏–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤—ñ–¥ –∫–æ–¥—É –ø–ª–∞–≥—ñ–Ω–∞ (code.ts) ---
      onmessage = (event) => {
        const msg = event.data.pluginMessage;

        if (msg.type === "tokens-update") {
          fetch("https://localhost:9000/tokens/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(msg.payload),
          })
            .then((res) =>
              res.ok ? res.json() : Promise.reject("Server error")
            )
            .then((data) => {
              // statusTokensDiv.textContent = "‚úÖ Tokens sent to server.";
              parent.postMessage(
                {
                  pluginMessage: {
                    type: "notify-success",
                    message: "TokensData sent to server!",
                  },
                },
                "*"
              );
            })
            .catch((err) => {
              // statusTokensDiv.textContent = "‚ùå Error!";
              parent.postMessage(
                {
                  pluginMessage: {
                    type: "notify-error",
                    message: "Can't update tokens. Check server.",
                  },
                },
                "*"
              );
            })
            .finally(() => {
              updateTokensButton.disabled = false;
              setTimeout(() => (statusTokensDiv.textContent = ""), 2000);
            });
        }

        if (msg.type === "component-generate") {
          fetch("https://localhost:9000/components/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(msg.payload),
          })
            .then((res) => {
              if (!res.ok) {
                // return Promise.reject("Server responded with an error.")
                resetGenerateUI()} 
              return res.json()
            })
            .then((data) => {
              if (data.message.includes("stop")) {
                console.log("Server confirmed cancellation");
              } else {
                // statusGenerateDiv.textContent = "‚úÖ Sent to Server!";
                parent.postMessage(
                  { pluginMessage: { 
                    type: "notify-success", 
                    message: "ComponentData Sent to Server!" 
                  } 
                },
                  "*"
                );
              }
            })
            .catch((error) => {
              if (statusGenerateDiv.textContent !== "Process stopped") {
                // statusGenerateDiv.textContent = "‚ùå Error!";
                console.error("Error:", error);
                parent.postMessage(
                  {
                    pluginMessage: {
                      type: "notify-error",
                      message: "Check console",
                    },
                  },
                  "*"
                );
              }
            })
            .finally(() => {
                resetGenerateUI();
            });
        }
      };
    </script>
  </body>
</html>
